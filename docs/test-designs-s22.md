# §22 テストケース設計（実装前に合意）

## IMP-001: LLM 駆動コンソリデーション (AUDN)

| テストケース | 入力 | 期待出力 | 備考 |
|-------------|------|---------|------|
| 正常: 新ファクト追加 | 既存にない新事実 | ADD 操作 | 基本パス |
| 正常: ファクト更新 | 既存ファクトの拡張情報 | UPDATE + 旧を superseded | 同一エンティティで新情報 |
| 正常: 矛盾削除 | 既存と矛盾する新事実 | DELETE 旧 + ADD 新 | 例: DB を Postgres → MySQL に変更 |
| 正常: 重複スキップ | 既存と同義の事実 | NOOP | セマンティック一致 |
| エラー: LLM 応答不正 | 不正な JSON | heuristic フォールバック | グレースフルデグレード |
| 境界: 類似度閾値境界 | 0.85 前後の類似スコア | 閾値以上=UPDATE, 未満=ADD | 閾値設定可能 |

## IMP-002: メモリ関係性タイプ拡張

| テストケース | 入力 | 期待出力 | 備考 |
|-------------|------|---------|------|
| 正常: updates リンク | 同一トピックの新旧ファクト | 旧→新に updates リンク作成 | 検索時に最新のみ表示 |
| 正常: extends リンク | 補足情報の追加 | 既存→新に extends リンク作成 | 両方とも検索で返る |
| 正常: 検索除外 | updates で上書きされた観察を検索 | 最新のみ返却 | graph 重みで旧を減衰 |
| 境界: 自己参照 | 同一 observation | リンク作成されない | ループ防止 |

## IMP-003: トークン最適化レイヤー

| テストケース | 入力 | 期待出力 | 備考 |
|-------------|------|---------|------|
| 正常: バジェット内 | 少量のファクト | 全ファクト含む | 切り捨てなし |
| 正常: バジェット超過 | 大量のファクト | 重要度上位のみ含む | 2000トークン以下 |
| 境界: バジェット 0 | budget=0 | 空の resume_pack | エラーにならない |
| 正常: カスタムバジェット | budget=500 | 500トークン以下 | 設定反映確認 |

## IMP-009: Signal Extraction

| テストケース | 入力 | 期待出力 | 備考 |
|-------------|------|---------|------|
| 正常: シグナル検出 | "remember: DBはPostgreSQLを使う" | importance += 0.3 | キーワードマッチ |
| 正常: ノイズ減衰 | `<environment_context>` 含むイベント | importance -= 0.2 | 環境コンテキスト |
| 正常: 複数シグナル | "fix: architecture decision" | importance += 0.3 (加算は1回) | 上限制御 |
| 境界: 上限 | 既に importance=0.9 + シグナル | importance = 1.0 | 上限 1.0 |
